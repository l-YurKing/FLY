# 蓝牙数据接收指南

## 📡 数据传输方式说明

您的飞控系统支持通过 **UART4蓝牙模块** 无线发送飞行数据！

---

## 🔌 硬件连接

### 飞控端
```
STM32F405 (UART4) ←→ 蓝牙模块 (HC-05/JDY-31等)
                      ↓ 无线传输
                   电脑蓝牙/串口助手
```

### 接收端需求
- **Windows**: 内置蓝牙或USB蓝牙适配器
- **Linux**: 内置蓝牙或USB蓝牙适配器
- **Mac**: 内置蓝牙
- **串口工具**: 任意串口助手（推荐sscom、PuTTY、Tera Term等）

---

## 🚀 快速开始

### 1️⃣ 配对蓝牙模块

**Windows系统**:
1. 打开"设置" → "蓝牙和其他设备"
2. 点击"添加蓝牙或其他设备"
3. 选择"蓝牙"
4. 找到飞控的蓝牙模块（通常名为 HC-05、JDY-31 等）
5. 输入配对码（默认通常是 `1234` 或 `0000`）
6. 配对成功后，系统会自动创建一个虚拟串口（如COM5）

**查看串口号**:
- 右键"此电脑" → "管理" → "设备管理器"
- 展开"端口(COM和LPT)"
- 找到类似 `标准串行通过蓝牙链接 (COM5)` 的设备

---

### 2️⃣ 编译并烧录代码

代码已配置为通过蓝牙发送数据：
```c
// balance_task.h 中的配置
#define ENABLE_FLIGHT_DATA_OUTPUT 1   // 启用数据输出
#define FLIGHT_DATA_USE_BLUETOOTH 1   // 使用蓝牙(UART4)
```

使用Keil编译并烧录到飞控板。

---

### 3️⃣ 使用串口助手接收数据

**推荐串口工具**:
- **sscom** (Windows): 简单易用的串口调试助手
- **PuTTY** (Windows/Linux/Mac): 通用终端工具
- **Tera Term** (Windows): 功能强大的终端模拟器
- **minicom** (Linux): 命令行串口工具
- **CoolTerm** (Mac): Mac平台串口工具

**配置参数**:
```
串口号: COM5 (根据实际配对的端口号)
波特率: 230400
数据位: 8
停止位: 1
校验位: None
流控制: None
```

**打开串口后会实时显示数据**（20Hz频率）:
```
[ATTITUDE] Roll:0.523 Pitch:-1.245 Yaw:45.678 | [GYRO] X:0.01 Y:-0.02 Z:0.00 | [ACCEL] X:-0.15 Y:0.03 Z:9.81 | [POSITION] H:1.234 X:0.056 Y:-0.023 | [TARGET] X:0.000 Y:0.000 | [SPEED] X:0.012 Y:-0.008 | [POWER] V:11.85 | [MOTOR] A:1245 B:1256 C:1234 D:1267
[ATTITUDE] Roll:0.512 Pitch:-1.198 Yaw:45.712 | [GYRO] X:0.00 Y:-0.01 Z:0.00 | [ACCEL] X:-0.14 Y:0.04 Z:9.82 | [POSITION] H:1.235 X:0.057 Y:-0.022 | [TARGET] X:0.000 Y:0.000 | [SPEED] X:0.013 Y:-0.007 | [POWER] V:11.84 | [MOTOR] A:1246 B:1257 C:1235 D:1268
...
```

---

## 📊 数据格式详解

每行数据包含以下信息（以 `|` 分隔不同类别）：

### [ATTITUDE] 姿态角度
```
Roll: 横滚角（度）
Pitch: 俯仰角（度）
Yaw: 偏航角（度）
```

### [GYRO] 陀螺仪角速度
```
X: X轴角速度（rad/s）
Y: Y轴角速度（rad/s）
Z: Z轴角速度（rad/s）
```

### [ACCEL] 加速度
```
X: X轴加速度（m/s²）
Y: Y轴加速度（m/s²）
Z: Z轴加速度（m/s²）
```

### [POSITION] 当前位置
```
H: 高度（米）
X: X方向位置（米）
Y: Y方向位置（米）
```

### [TARGET] 目标位置
```
X: X方向目标位置（米）
Y: Y方向目标位置（米）
```

### [SPEED] 速度
```
X: X方向速度（m/s）
Y: Y方向速度（m/s）
```

### [POWER] 电源
```
V: 电池电压（伏特）
```

### [MOTOR] 电机油门
```
A: 电机A油门值（48-2047）
B: 电机B油门值（48-2047）
C: 电机C油门值（48-2047）
D: 电机D油门值（48-2047）
```

---

## ⚙️ 配置选项

### 切换回有线串口（USART1）

如果想改回USB有线传输，修改 `balance_task.h`:
```c
#define FLIGHT_DATA_USE_BLUETOOTH 0   // 改为0使用USART1
```

### 调整输出频率

在 `balance_task.c` 第746行修改分频系数：
```c
if( ++dataOutputCounter >= 10 )  // 10 = 200Hz/10 = 20Hz输出
// 改为20可获得10Hz输出
// 改为5可获得40Hz输出
```

---

## ⚠️ 注意事项

### 1. 蓝牙与APP功能冲突
UART4同时用于：
- 蓝牙APP控制（bluetoothControl_task.c）
- 飞行数据输出（balance_task.c）

**解决方案**：
- 数据输出使用互斥锁保护，不会完全阻塞APP功能
- 如需同时使用APP显示，建议降低数据输出频率

### 2. 蓝牙传输距离
- 标准蓝牙2.0/3.0: 约10米
- 蓝牙4.0 BLE: 约30-50米
- 实际距离受环境影响

### 3. 数据丢失
蓝牙传输可能因信号干扰导致数据丢失，这是正常现象。

### 4. 波特率匹配
确保蓝牙模块配置的波特率为 **230400**（与UART4一致）。

---

## 🐛 故障排查

| 问题 | 解决方法 |
|-----|---------|
| 找不到蓝牙设备 | 检查蓝牙模块是否上电，LED是否闪烁 |
| 配对失败 | 尝试配对码 1234、0000、1111 |
| 无数据接收 | 1. 检查 `ENABLE_FLIGHT_DATA_OUTPUT` 是否为1<br>2. 检查飞控是否上电启动<br>3. 检查蓝牙是否已连接 |
| 数据乱码 | 确认波特率为230400，数据位8，停止位1，无校验 |
| 数据断断续续 | 1. 靠近飞控减少干扰<br>2. 降低输出频率 |

---

## 🔄 两种模式对比

| 特性 | 蓝牙模式 | USB有线模式 |
|-----|---------|------------|
| 传输方式 | UART4无线 | USART1有线 |
| 飞行时使用 | ✅ 可以 | ❌ 需拖线 |
| 传输距离 | 10-50米 | USB线长度 |
| 数据可靠性 | 中等 | 高 |
| 与APP冲突 | 有轻微影响 | 无影响 |
| 波特率 | 230400 | 256000 |
| 数据格式 | 带标签的可读格式 | 带标签的可读格式 |

---

## 💡 使用建议

1. **调试阶段**: 建议使用USB有线模式，数据更稳定
2. **飞行测试**: 使用蓝牙无线模式，方便实时监控
3. **数据记录**: 串口助手可保存为文本文件，方便后续分析
4. **多开功能**: 可同时打开多个串口助手窗口，一个用于监控姿态，一个用于监控电机等

---

## 📞 技术支持

如有问题，请检查：
1. 蓝牙是否已配对并连接
2. 飞控是否已上电
3. 串口工具是否正确配置波特率（230400）
4. 串口号是否正确

---

**最后更新**: 2026-01-17
**作者**: l-YurKing
**GitHub**: https://github.com/l-YurKing/FLY
